<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin – Beta Tester Invoices</title>
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0d1117;
      --surface: #161b22;
      --border: #30363d;
      --text: #e6edf3;
      --text-muted: #8b949e;
      --accent: #58a6ff;
      --accent-hover: #79b8ff;
      --success: #3fb950;
      --danger: #f85149;
      --radius: 8px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Outfit', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 2rem;
      background-image:
        radial-gradient(ellipse 80% 50% at 50% -20%, rgba(88, 166, 255, 0.12), transparent),
        radial-gradient(ellipse 60% 40% at 100% 100%, rgba(63, 185, 80, 0.06), transparent);
    }

    .container { max-width: 900px; margin: 0 auto; }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    h1 { font-size: 1.5rem; font-weight: 600; }

    .back-link {
      color: var(--accent);
      text-decoration: none;
      font-size: 0.9rem;
    }
    .back-link:hover { text-decoration: underline; }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      margin-bottom: 2rem;
    }

    .invoice-row {
      display: grid;
      grid-template-columns: 100px 1fr 1fr 80px 80px 100px 110px 120px;
      gap: 1rem;
      align-items: center;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border);
      font-size: 0.9rem;
    }

    .invoice-row:last-child { border-bottom: none; }

    .invoice-row.header {
      background: rgba(255,255,255,0.03);
      font-weight: 500;
      color: var(--text-muted);
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .invoice-row .amount {
      font-family: 'JetBrains Mono', monospace;
      color: var(--success);
      cursor: pointer;
      user-select: none;
    }
    .invoice-row .amount:hover { text-decoration: underline; }
    .invoice-row .status { font-size: 0.8rem; }
    .invoice-row .status.confirmed { color: var(--success); }
    .invoice-row .status.pending { color: var(--text-muted); }
    .created-time.recent { color: var(--danger); font-weight: 500; }

    .btn {
      padding: 0.45rem 0.85rem;
      font-family: 'Outfit', sans-serif;
      font-size: 0.85rem;
      font-weight: 500;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn:not(:disabled):hover { opacity: 0.9; }

    .btn-confirm {
      background: var(--success);
      color: var(--bg);
    }

    .empty, .loading {
      padding: 3rem;
      text-align: center;
      color: var(--text-muted);
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Admin – Invoice Requests</h1>
      <a class="back-link" href="/">← Back to invoice form</a>
    </header>

    <div class="card">
      <div class="invoice-row header">
        <div>Invoice #</div>
        <div>Nickname</div>
        <div>Full Name</div>
        <div>Bugs</div>
        <div>Hours</div>
        <div>Amount</div>
        <div>Created</div>
        <div>Status</div>
      </div>
      <div id="invoiceList">
        <div class="loading" id="loading">Loading invoices…</div>
      </div>
    </div>
  </div>

  <script>
    let timeRefreshInterval;
    let pollInterval;

    async function loadInvoices() {
      const list = document.getElementById('invoiceList');
      const loading = document.getElementById('loading');

      try {
        const res = await fetch('/api/admin/invoices');
        const { data } = await res.json();

        if (loading && loading.parentNode) loading.remove();

        if (!data || data.length === 0) {
          list.innerHTML = '<div class="empty">No invoices yet</div>';
          startPolling();
          return;
        }

        list.innerHTML = data.map((inv) => {
          const { text: created, recent } = formatCreated(inv.createdAt);
          const createdClass = recent ? ' created-time recent' : ' created-time';
          const confirmed = inv.confirmedByAdmin;
          return `
            <div class="invoice-row" data-id="${inv._id}">
              <div>${escapeHtml(inv.invoiceNumber || '—')}</div>
              <div>${escapeHtml(inv.nickname)}</div>
              <div>${escapeHtml(inv.fullName)}</div>
              <div>${inv.bugsCount}</div>
              <div>${inv.gameplayTime}</div>
              <div class="amount" onclick="copyAmount('${inv.amount}')" title="Click to copy">${inv.amount} USDT</div>
              <div class="${createdClass.trim()}" data-created="${inv.createdAt}">${created}</div>
              <div>
                ${confirmed
                  ? '<span class="status confirmed">Confirmed</span>'
                  : `<button class="btn btn-confirm" onclick="confirmInvoice('${inv._id}', this)">Confirm</button>`
                }
              </div>
            </div>
          `;
        }).join('');

        startTimeRefresh();
        startPolling();
      } catch (err) {
        if (loading && loading.parentNode) {
          loading.textContent = 'Failed to load invoices';
        } else {
          list.innerHTML = '<div class="empty">Failed to load invoices</div>';
        }
      }
    }

    function escapeHtml(s) {
      const d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }

    function formatCreated(isoStr) {
      const d = new Date(isoStr);
      const now = Date.now();
      const ms = now - d.getTime();
      const secs = Math.floor(ms / 1000);
      const mins = Math.floor(secs / 60);
      const oneHour = 60 * 60 * 1000;
      const tenMins = 10 * 60 * 1000;
      const recent = ms < tenMins;

      let text;
      if (ms < oneHour) {
        if (secs < 5) text = 'a few secs ago';
        else if (secs < 60) text = secs + ' secs ago';
        else if (mins === 1) text = 'a min ago';
        else text = mins + ' mins ago';
      } else {
        text = d.toLocaleString();
      }
      return { text, recent };
    }

    function startTimeRefresh() {
      clearInterval(timeRefreshInterval);
      timeRefreshInterval = setInterval(() => {
        document.querySelectorAll('.created-time').forEach((el) => {
          const iso = el.dataset.created;
          if (iso) {
            const { text, recent } = formatCreated(iso);
            el.textContent = text;
            el.classList.toggle('recent', recent);
          }
        });
      }, 10000);
    }

    function startPolling() {
      clearInterval(pollInterval);
      pollInterval = setInterval(loadInvoices, 2000);
    }

    function copyAmount(text) {
      navigator.clipboard.writeText(text);
    }

    async function confirmInvoice(id, btn) {
      btn.disabled = true;
      btn.textContent = '…';
      try {
        const res = await fetch(`/api/admin/invoices/${id}/confirm`, { method: 'PATCH' });
        const json = await res.json();
        if (json.success) {
          copyAmount(String(json.data.amount));
          const row = document.querySelector(`[data-id="${id}"]`);
          const statusCell = row && row.querySelector('div:nth-child(8)');
          if (statusCell) statusCell.innerHTML = '<span class="status confirmed">Confirmed</span>';
        } else {
          btn.disabled = false;
          btn.textContent = 'Confirm';
        }
      } catch (err) {
        btn.disabled = false;
        btn.textContent = 'Confirm';
      }
    }

    loadInvoices();
  </script>
</body>
</html>
