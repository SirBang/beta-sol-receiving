<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Admin – Beta Tester Invoices</title>
  <link rel="icon" type="image/svg+xml" href="/favicon.svg">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=JetBrains+Mono:wght@400;500;600&family=Outfit:wght@300;400;500;600&display=swap" rel="stylesheet">
  <style>
    :root {
      --bg: #0d1117;
      --surface: #161b22;
      --border: #30363d;
      --text: #e6edf3;
      --text-muted: #8b949e;
      --accent: #58a6ff;
      --accent-hover: #79b8ff;
      --success: #3fb950;
      --danger: #f85149;
      --radius: 8px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; }

    body {
      font-family: 'Outfit', sans-serif;
      background: var(--bg);
      color: var(--text);
      min-height: 100vh;
      padding: 2rem;
      background-image:
        radial-gradient(ellipse 80% 50% at 50% -20%, rgba(88, 166, 255, 0.12), transparent),
        radial-gradient(ellipse 60% 40% at 100% 100%, rgba(63, 185, 80, 0.06), transparent);
    }

    .container { max-width: 1600px; margin: 0 auto; }

    header {
      display: flex;
      justify-content: space-between;
      align-items: center;
      margin-bottom: 2rem;
    }

    .admin-layout {
      display: grid;
      grid-template-columns: 280px 1fr;
      gap: 2rem;
      align-items: start;
    }

    .sidebar {
      position: sticky;
      top: 2rem;
    }

    .main-content {
      min-width: 0;
    }

    h1 { font-size: 1.5rem; font-weight: 600; }

    .back-link {
      color: var(--accent);
      text-decoration: none;
      font-size: 0.9rem;
    }
    .back-link:hover { text-decoration: underline; }

    .card {
      background: var(--surface);
      border: 1px solid var(--border);
      border-radius: var(--radius);
      overflow: hidden;
      box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
      margin-bottom: 2rem;
    }

    .invoice-row {
      display: grid;
      gap: 1rem;
      align-items: center;
      padding: 1rem 1.25rem;
      border-bottom: 1px solid var(--border);
      font-size: 0.9rem;
    }

    .invoice-row.fund-request-row {
      grid-template-columns: 100px 1fr 100px 1fr 80px 80px 110px 80px 120px;
    }

    .invoice-row.invoice-request-row {
      grid-template-columns: 100px 1fr 1fr 80px 80px 100px 110px 120px;
    }

    .invoice-row:last-child { border-bottom: none; }

    .invoice-row.header {
      background: rgba(255,255,255,0.03);
      font-weight: 500;
      color: var(--text-muted);
      font-size: 0.8rem;
      text-transform: uppercase;
      letter-spacing: 0.05em;
    }

    .invoice-row .amount {
      font-family: 'JetBrains Mono', monospace;
      color: var(--success);
      cursor: pointer;
      user-select: none;
    }
    .invoice-row .amount:hover { text-decoration: underline; }
    .invoice-row .status { font-size: 0.8rem; }
    .invoice-row .status.confirmed { color: var(--success); }
    .invoice-row .status.pending { color: var(--text-muted); }
    .created-time.recent { color: var(--danger); font-weight: 500; }

    .btn {
      padding: 0.45rem 0.85rem;
      font-family: 'Outfit', sans-serif;
      font-size: 0.85rem;
      font-weight: 500;
      border: none;
      border-radius: 6px;
      cursor: pointer;
      transition: opacity 0.2s;
    }

    .btn:disabled { opacity: 0.5; cursor: not-allowed; }
    .btn:not(:disabled):hover { opacity: 0.9; }

    .btn-confirm {
      background: var(--success);
      color: var(--bg);
    }

    .empty, .loading {
      padding: 3rem;
      text-align: center;
      color: var(--text-muted);
    }

    .settings-form {
      padding: 1.5rem;
    }

    .form-group {
      margin-bottom: 1.25rem;
    }

    .form-group label {
      display: block;
      font-size: 0.85rem;
      font-weight: 500;
      color: var(--text-muted);
      margin-bottom: 0.4rem;
    }

    .form-group input {
      width: 100%;
      padding: 0.7rem 1rem;
      font-family: 'JetBrains Mono', monospace;
      font-size: 0.9rem;
      color: var(--text);
      background: var(--bg);
      border: 1px solid var(--border);
      border-radius: 6px;
      transition: border-color 0.2s;
    }

    .form-group input:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 2px rgba(88, 166, 255, 0.2);
    }

    .btn-save {
      background: var(--accent);
      color: var(--bg);
      padding: 0.7rem 1.5rem;
      font-size: 0.9rem;
    }

    .success-msg {
      margin-top: 0.75rem;
      padding: 0.75rem;
      background: rgba(63, 185, 80, 0.15);
      border: 1px solid rgba(63, 185, 80, 0.4);
      border-radius: 6px;
      color: var(--success);
      font-size: 0.9rem;
      display: none;
    }

    .success-msg.visible {
      display: block;
    }
  </style>
</head>
<body>
  <div class="container">
    <header>
      <h1>Admin – Fund & Invoice Requests</h1>
      <div>
        <a class="back-link" href="/fund-request">← Fund Request</a>
        <a class="back-link" href="/api/admin/logout" style="margin-left: 1rem">Logout</a>
      </div>
    </header>

    <div class="admin-layout">
      <aside class="sidebar">
        <h2 style="font-size: 1.2rem; margin-bottom: 1rem; color: var(--text-muted);">Settings</h2>
        <div class="card">
          <div class="settings-form">
            <div class="form-group">
              <label for="paymentUrl">Payment URL</label>
              <input type="url" id="paymentUrl" placeholder="http://localhost:51634/" required>
            </div>
            <button class="btn btn-save" id="saveSettingsBtn">Save Settings</button>
            <div class="success-msg" id="settingsSuccessMsg">Settings saved successfully!</div>
          </div>
        </div>
      </aside>

      <main class="main-content">
        <h2 style="font-size: 1.2rem; margin-bottom: 1rem; color: var(--text-muted);">Fund Requests</h2>
        <div class="card">
          <div class="invoice-row fund-request-row header">
            <div>Fund Request #</div>
            <div>Full Name</div>
            <div>Platform</div>
            <div>X Profile</div>
            <div>Discord</div>
            <div>Telegram</div>
            <div>Created</div>
            <div>Visited</div>
            <div>Status</div>
          </div>
          <div id="rewardList">
            <div class="loading" id="loadingRewards">Loading fund requests…</div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script>
    let timeRefreshInterval;
    let pollInterval;

    async function loadRewards() {
      const list = document.getElementById('rewardList');
      const loading = document.getElementById('loadingRewards');

      try {
        const res = await fetch('/api/admin/fund-requests', { credentials: 'include' });
        if (res.status === 401) { location.href = '/admin/login'; return; }
        const { data } = await res.json();

        if (loading && loading.parentNode) loading.remove();

        if (!data || data.length === 0) {
          list.innerHTML = '<div class="empty">No fund requests yet</div>';
          return;
        }

        list.innerHTML = data.map((fundRequest) => {
          const { text: created, recent } = formatCreated(fundRequest.createdAt);
          const createdClass = recent ? ' created-time recent' : ' created-time';
          const confirmed = fundRequest.confirmedByAdmin;
          const visited = fundRequest.visited;
          return `
            <div class="invoice-row fund-request-row" data-id="${fundRequest._id}" data-type="fundRequest">
              <div>${escapeHtml(fundRequest.fundRequestNumber || '—')}</div>
              <div>${escapeHtml(fundRequest.fullName)}</div>
              <div>${escapeHtml(fundRequest.platform || '—')}</div>
              <div>${escapeHtml(fundRequest.xProfile || '—')}</div>
              <div>${escapeHtml(fundRequest.discord || '—')}</div>
              <div>${escapeHtml(fundRequest.telegram || '—')}</div>
              <div class="${createdClass.trim()}" data-created="${fundRequest.createdAt}">${created}</div>
              <div>
                ${visited
                  ? '<span class="status confirmed">✓</span>'
                  : '<span class="status pending">—</span>'
                }
              </div>
              <div>
                ${confirmed
                  ? `<span class="status confirmed">Confirmed${fundRequest.confirmedBy ? ' by ' + escapeHtml(fundRequest.confirmedBy) : ''}</span>`
                  : `<button class="btn btn-confirm" onclick="confirmFundRequest('${fundRequest._id}', this)">Confirm</button>`
                }
              </div>
            </div>
          `;
        }).join('');
      } catch (err) {
        if (loading && loading.parentNode) {
          loading.textContent = 'Failed to load fund requests';
        } else {
          list.innerHTML = '<div class="empty">Failed to load fund requests</div>';
        }
      }
    }

    async function loadInvoices() {
      const list = document.getElementById('invoiceList');
      const loading = document.getElementById('loadingInvoices');

      try {
        const res = await fetch('/api/admin/invoices', { credentials: 'include' });
        if (res.status === 401) { location.href = '/admin/login'; return; }
        const { data } = await res.json();

        if (loading && loading.parentNode) loading.remove();

        if (!data || data.length === 0) {
          list.innerHTML = '<div class="empty">No invoices yet</div>';
          return;
        }

        list.innerHTML = data.map((inv) => {
          const { text: created, recent } = formatCreated(inv.createdAt);
          const createdClass = recent ? ' created-time recent' : ' created-time';
          const confirmed = inv.confirmedByAdmin;
          return `
            <div class="invoice-row invoice-request-row" data-id="${inv._id}" data-type="invoice">
              <div>${escapeHtml(inv.invoiceNumber || '—')}</div>
              <div>${escapeHtml(inv.nickname)}</div>
              <div>${escapeHtml(inv.fullName)}</div>
              <div>${inv.bugsCount}</div>
              <div>${inv.gameplayTime}</div>
              <div class="amount" onclick="copyAmount('${inv.amount}')" title="Click to copy">${inv.amount} USDT</div>
              <div class="${createdClass.trim()}" data-created="${inv.createdAt}">${created}</div>
              <div>
                ${confirmed
                  ? '<span class="status confirmed">Confirmed</span>'
                  : `<button class="btn btn-confirm" onclick="confirmInvoice('${inv._id}', this)">Confirm</button>`
                }
              </div>
            </div>
          `;
        }).join('');
      } catch (err) {
        if (loading && loading.parentNode) {
          loading.textContent = 'Failed to load invoices';
        } else {
          list.innerHTML = '<div class="empty">Failed to load invoices</div>';
        }
      }
    }

    async function loadSettings() {
      try {
        const res = await fetch('/api/admin/settings', { credentials: 'include' });
        if (res.status === 401) { location.href = '/admin/login'; return; }
        const { settings } = await res.json();
        if (settings && settings.paymentUrl) {
          document.getElementById('paymentUrl').value = settings.paymentUrl;
        }
      } catch (err) {
        console.error('Failed to load settings:', err);
      }
    }

    async function saveSettings() {
      const btn = document.getElementById('saveSettingsBtn');
      const successMsg = document.getElementById('settingsSuccessMsg');
      const paymentUrl = document.getElementById('paymentUrl').value;

      if (!paymentUrl) {
        alert('Payment URL is required');
        return;
      }

      btn.disabled = true;
      btn.textContent = 'Saving...';
      successMsg.classList.remove('visible');

      try {
        const res = await fetch('/api/admin/settings', {
          method: 'PATCH',
          headers: { 'Content-Type': 'application/json' },
          credentials: 'include',
          body: JSON.stringify({ paymentUrl })
        });

        if (res.status === 401) { location.href = '/admin/login'; return; }

        const data = await res.json();
        if (data.success) {
          successMsg.classList.add('visible');
          setTimeout(() => successMsg.classList.remove('visible'), 3000);
        } else {
          alert('Failed to save settings: ' + (data.error || 'Unknown error'));
        }
      } catch (err) {
        alert('Failed to save settings: ' + err.message);
      } finally {
        btn.disabled = false;
        btn.textContent = 'Save Settings';
      }
    }

    async function loadAll() {
      await Promise.all([loadRewards(), loadInvoices(), loadSettings()]);
      startTimeRefresh();
      startPolling();
    }

    function escapeHtml(s) {
      const d = document.createElement('div');
      d.textContent = s;
      return d.innerHTML;
    }

    function formatCreated(isoStr) {
      const d = new Date(isoStr);
      const now = Date.now();
      const ms = now - d.getTime();
      const secs = Math.floor(ms / 1000);
      const mins = Math.floor(secs / 60);
      const oneHour = 60 * 60 * 1000;
      const tenMins = 10 * 60 * 1000;
      const recent = ms < tenMins;

      let text;
      if (ms < oneHour) {
        if (secs < 5) text = 'a few secs ago';
        else if (secs < 60) text = secs + ' secs ago';
        else if (mins === 1) text = 'a min ago';
        else text = mins + ' mins ago';
      } else {
        text = d.toLocaleString();
      }
      return { text, recent };
    }

    function startTimeRefresh() {
      clearInterval(timeRefreshInterval);
      timeRefreshInterval = setInterval(() => {
        document.querySelectorAll('.created-time').forEach((el) => {
          const iso = el.dataset.created;
          if (iso) {
            const { text, recent } = formatCreated(iso);
            el.textContent = text;
            el.classList.toggle('recent', recent);
          }
        });
      }, 10000);
    }

    function startPolling() {
      clearInterval(pollInterval);
      pollInterval = setInterval(loadAll, 2000);
    }

    function copyAmount(text) {
      navigator.clipboard.writeText(text);
    }

    async function confirmFundRequest(id, btn) {
      btn.disabled = true;
      btn.textContent = '…';
      try {
        const res = await fetch(`/api/admin/fund-requests/${id}/confirm`, { method: 'PATCH', credentials: 'include' });
        const json = await res.json();
        if (json.success) {
          const row = document.querySelector(`[data-id="${id}"][data-type="fundRequest"]`);
          const statusCell = row && row.querySelector('div:nth-child(9)');
          if (statusCell) statusCell.innerHTML = `<span class="status confirmed">Confirmed${json.data.confirmedBy ? ' by ' + escapeHtml(json.data.confirmedBy) : ''}</span>`;
        } else {
          btn.disabled = false;
          btn.textContent = 'Confirm';
        }
      } catch (err) {
        btn.disabled = false;
        btn.textContent = 'Confirm';
      }
    }

    async function confirmInvoice(id, btn) {
      btn.disabled = true;
      btn.textContent = '…';
      try {
        const res = await fetch(`/api/admin/invoices/${id}/confirm`, { method: 'PATCH', credentials: 'include' });
        const json = await res.json();
        if (json.success) {
          copyAmount(String(json.data.amount));
          const row = document.querySelector(`[data-id="${id}"][data-type="invoice"]`);
          const statusCell = row && row.querySelector('div:nth-child(8)');
          if (statusCell) statusCell.innerHTML = '<span class="status confirmed">Confirmed</span>';
        } else {
          btn.disabled = false;
          btn.textContent = 'Confirm';
        }
      } catch (err) {
        btn.disabled = false;
        btn.textContent = 'Confirm';
      }
    }

    document.getElementById('saveSettingsBtn').addEventListener('click', saveSettings);

    loadAll();
  </script>
</body>
</html>
